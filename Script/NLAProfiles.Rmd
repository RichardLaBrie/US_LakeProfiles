---
title: "StrataNLA"
author: "Richard LaBrie"
date: "10/09/2020"
output: html_document
---

#Load libraries and functions
```{R}
library("oce")
library("rLakeAnalyzer")
library("rMR")
library("missForest")
library("party")
library("randomForest")
library(caret)
library(car)


home_strata_fct <- function(FileList, Year)
{
  output = matrix(nrow=4, ncol=length(FileList))
  colnames(output) = FileList
  for(i in 1:length(FileList))
  {
    data = read.csv(paste0("../data/",Year,"/", FileList[i]))
    filename = unlist(strsplit(FileList[i],split = "[.]"))[1]

  
    if(length(data$temp[!is.na(data$temp)]) < length(data$temp))    data = data[-which(is.na(data$temp)),]
    if(length(unique(data$temp) == "NA") == 1)
    {
      output[1,i] = -1
      output[2,i] = -1
      output[3,i] = -1
      output[4,i] = -1
      colnames(output)[i] <- paste(filename)
      next
    }
    temporaire = meta.depths(wtr = data$temp, depths = data$depth)
  
    output[1,i] = min(data$depth)
    output[4,i] = max(data$depth)
    output[2,i] = if((max(data$temp)-min(data$temp)) > 1) temporaire[1]  else -1
    output[3,i] = if((max(data$temp)-min(data$temp)) > 1) temporaire[2]  else -1
    colnames(output)[i] <- paste(filename)
  }
return(output)
}

home_thermo_fct <- function(FileList, Year)
{
  output = matrix(nrow=4, ncol=length(FileList))
  colnames(output) = FileList
  for(i in 1:length(FileList))
  {
    data = read.csv(paste0("../data/Preprocessing/",Year,"/", FileList[i]))
    data = data[-1,]
    filename = unlist(strsplit(FileList[i],split = "[.]"))[1]

  
    if(length(data$temp[!is.na(data$temp)]) < length(data$temp))    data = data[-which(is.na(data$temp)),]
    if(length(unique(data$temp) == "NA") == 1)
    {
      output[1,i] = -1
      output[2,i] = -1
      output[3,i] = -1
      output[4,i] = -1
      colnames(output)[i] <- paste(filename)
      next
    }
    temporaire = thermo.depth(wtr = data$temp, depths = data$depth)
  
    output[1,i] = min(data$depth)
    output[4,i] = max(data$depth)
    output[2,i] = if((max(data$temp)-min(data$temp)) > 1) temporaire[1]  else -1
    output[3,i] = ifelse((max(data$temp)-min(data$temp)) > 1, ifelse(length(data$depth[which(abs(temporaire-data$depth) == min(abs(temporaire-data$depth)))])==2, data$depth[which(abs(temporaire-data$depth) == min(abs(temporaire-data$depth)))][2], data$depth[which(abs(temporaire-data$depth) == min(abs(temporaire-data$depth)))]), -1)
    colnames(output)[i] <- paste(filename)
  }
return(output)
}

source('./MetalimnionWetzel.R', encoding = 'UTF-8')
source('./AOU.R', encoding = 'UTF-8')
source('./VolAOU.R', encoding = 'UTF-8')
source('./VolTemp.R', encoding = 'UTF-8')
source('./SedVar.R', encoding = 'UTF-8')


```

#Load and transform data
```{r}
metadata0712 = read.table("../data/info_0712.tsv", sep = "\t", header = T)
Temp_sat = read.csv("../nla_noaa-master/data//processed/temp_noaa_output.csv", row.names = 1)
allfiles07 = list.files("../data/Preprocessing/2007")
allfiles12 = list.files("../data/Preprocessing/2012")

#Remove lakes with max depth less than 2m
deeplist07 = list()
deeplist12 = list()
for(i in 1:length(allfiles07))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",allfiles07[i]))
  if(max(data$depth) >=2) deeplist07[[i]] = i
}
for(i in 1:length(allfiles12))
{
  data = read.csv(paste0("../data/Preprocessing/2012/",allfiles12[i]))
  if(max(data$depth) >=2) deeplist12[[i]] = i
}
deep07 = allfiles07[unlist(deeplist07)] #962 lakes deeper than 2m
deep12 = allfiles12[unlist(deeplist12)] #854 lakes deeper than 2m

#Select lakes with latitude >40°
allmore40 = metadata0712[which(metadata0712$lat >= 40),]
deep07.temp = unlist(strsplit(deep07, ".csv"))
deep12.temp = unlist(strsplit(deep12, ".csv"))

allmore4007 = allmore40[allmore40$year==2007,]
metadata.more40deep07 = allmore4007[match(deep07.temp, allmore4007$site_id),]
indexNA07 = list()
for(i in 1:dim(metadata.more40deep07)[1])
{
  if(all(is.na(metadata.more40deep07[i,])))  indexNA07[[i]] = i
}
indexNA07 = unlist(indexNA07)
metadata.more40deep07 = metadata.more40deep07[-indexNA07,]
rm(allmore4007)

allmore4012 = allmore40[allmore40$year!=2007,]
metadata.more40deep12= allmore4012[match(deep12.temp, allmore4012$site_id),]
indexNA12 = list()
for(i in 1:dim(metadata.more40deep12)[1])
{
  if(all(is.na(metadata.more40deep12[i,])))  indexNA12[[i]] = i
}
indexNA12 = unlist(indexNA12)
metadata.more40deep12 = metadata.more40deep12[-indexNA12,]
rm(allmore4012)

#Select correspoding filenames
deeplat07 = deep07[match(metadata.more40deep07$site_id, deep07.temp)] #531 lakes deeper than 2m and >40°N
deeplat12 = deep12[match(metadata.more40deep12$site_id, deep12.temp)] #503 lakes deeper than 2m and >40°N

#remove temporary objects
rm(deep07.temp)
rm(deep12.temp)

#Hypolimnion
#calculate metalimnion strata for all lakes in 2007 and 2012
strata07 = home_strata_temp(deeplat07, 2007)
strata12 = home_strata_temp(deeplat12, 2012)

#Select those that have a hypolimnion
hypo07 = strata07[,which(strata07[3,] != -1 & strata07[3,] != strata07[4,])]
hypo12 = strata12[,which(strata12[3,] != -1 & strata12[3,] != strata12[4,])]

#Create binary response variable: w/ or w/o hypolimion
Binhypo07 = strata07[1,]
Binhypo12 = strata12[1,]
for(i in 1:length(Binhypo07))
{
  Binhypo07[i] = ifelse(strata07[3,i] == -1 | strata07[3,i] == strata07[4,i], "0", "1")
}
for(i in 1:length(Binhypo12))
{
  Binhypo12[i] = ifelse(strata12[3,i] == -1 | strata12[3,i] == strata12[4,i], "0", "1")
}

#

##Calculate O2 saturation
O2sat07 = Eq.Ox.conc(temp.C = Temp_sat[c(1:531), "temp_mean_min_1m"],
                     elevation.m = metadata.more40deep07[,"elevation_m"],
                     out.DO.meas = "mg/L")
names(O2sat07) = Temp_sat$station[c(1:531)]
O2sat12 = Eq.Ox.conc(temp.C = Temp_sat[c(532:1034), "temp_mean_min_1m"],
                     elevation.m = metadata.more40deep12[,"elevation_m"],
                     out.DO.meas = "mg/L")
names(O2sat12) = Temp_sat$station[c(532:1034)]

#Remove lakes w/o hypolimnion
O2sat07 = O2sat07[which(strata07[3,] != -1 & strata07[3,] != strata07[4,])]
O2sat12 = O2sat12[which(strata12[3,] != -1 & strata12[3,] != strata12[4,])]
metadata.hypo07 = metadata.more40deep07[which(strata07[3,] != -1 & strata07[3,] != strata07[4,]),]
metadata.hypo12 = metadata.more40deep12[which(strata12[3,] != -1 & strata12[3,] != strata12[4,]),]

#Remove lakes w/o DO measurements
index07 = list()
for(i in 1:dim(hypo07)[2])
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(hypo07)[i], ".csv"), row.names = 1)
  if(all(is.na(data$DO))) index07[[i]] = i
}

index07 = unlist(index07)
index12 = 187 #DO value only at the surface

O2sat07 = O2sat07[-index07]
hypo07 = hypo07[,-index07]
metadata.hypo07 = metadata.hypo07[-index07,]

O2sat12 = O2sat12[-index12]
hypo12 = hypo12[,-index12]
metadata.hypo12 = metadata.hypo12[-index12,]

#Remove lakes where average hypo DO > saturation DO (Burns 1995)
# index07 = list()
# for(i in 1:dim(hypo07)[2])
# {
#   data = read.csv(paste0("../data/Preprocessing/2007/",colnames(hypo07)[i], ".csv"), row.names = 1)
#   if(mean(data$DO[which(data$depth>=hypo07[3,i] & data$depth <= hypo07[4,i])]) >= O2sat07[i]) index07[[i]] = i
# }
# index07 = unlist(index07)
# 
# O2sat07 = O2sat07[-index07]
# hypo07 = hypo07[,-index07]
# metadata.hypo07 = metadata.hypo07[-index07,]


# index12 = list()
# for(i in c(1:190))#dim(hypo12)[2]
# {
#   data = read.csv(paste0("../data/Preprocessing/2012/",colnames(hypo12)[i], ".csv"), row.names = 1)
#   if(i==72 || i==74|| i==99|| i==110|| i==145|| i==167|| i==176) next #these lacs have missing anoxic values at the bottom, which will be filled to adequately estimate AOU 
#   if(mean(data$DO[which(data$depth>=hypo12[3,i] & data$depth <= hypo12[4,i])]) >= O2sat12[i]) index12[[i]] = i
# }
# index12 = unlist(index12)
# 
# O2sat12 = O2sat12[-index12]
# hypo12 = hypo12[,-index12]
# metadata.hypo12 = metadata.hypo12[-index12,]


#Calculate AOU
AOU07 = AOU(hypo07, 2007, O2sat07)
AOU12 = AOU(hypo12, 2012, O2sat12)

#Calculate volumetric AOU
Area07 = metadata.hypo07$area_km2*1000*1000
Area12 = metadata.hypo12$area_km2*1000*1000

VolAOU07 = VolumetricAOU(AOU07, Area07)
VolAOU12 = VolumetricAOU(AOU12, Area12)

#Calculate volumetric oxygen content
VolO207 = list()
for(i in 1:length(AOU07))
{
  VolO207[[i]] = cbind(Depth=AOU07[[i]][,1], Sat=O2sat07[i])
}
VolO212 = list()
for(i in 1:length(AOU12))
{
  VolO212[[i]] = cbind(Depth=AOU12[[i]][,1], Sat=O2sat12[i])
}

VolSat07 = VolumetricAOU(VolO207, Area07)
VolSat12 = VolumetricAOU(VolO212, Area12)

#Percentage of O2 consumed
RelO207 = VolAOU07/VolSat07*100 #Range from -27% (surtaturated) to 100% (all O2 is consumed)
RelO212 = VolAOU12/VolSat12*100 #Range from -9% (sursaturated) to 100% 

#Calculate hypolimnion temperature weighted mean
VolT07 = VolTemp(hypo07, 2007, Area07)
VolT12 = VolTemp(hypo12, 2012, Area12)

#Calculate sediment and volume to sediment ratio
SedVar07 = SedArea(hypo07, 2007, Area07)
SedVar12 = SedArea(hypo12, 2012, Area12)

#Create binary variable for hypoxia and anoxia
hypox07 = list()
for(i in c(1:dim(hypo07)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(hypo07)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 2) {hypox07[[i]] = 1} else {hypox07[[i]]=0}
}

anox07 = list()
for(i in c(1:dim(hypo07)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(hypo07)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 0.5) {anox07[[i]] = 1} else {anox07[[i]]=0}
}

hypox12 = list()
for(i in c(1:dim(hypo12)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2012/",colnames(hypo12)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 2) {hypox12[[i]] = 1} else {hypox12[[i]]=0}
}

anox12 = list()
for(i in c(1:dim(hypo12)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2012/",colnames(hypo12)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 0.5) {anox12[[i]] = 1} else {anox12[[i]]=0}
}

hypox07 = as.factor(unlist(hypox07))
anox07 = as.factor(unlist(anox07))
hypox12 = as.factor(unlist(hypox12))
anox12 = as.factor(unlist(anox12))

#Combined dataframes
metadata.hypo07 = cbind(metadata.hypo07, RelO207, VolT07, SedVar07, hypox07, anox07)
metadata.hypo12 = cbind(metadata.hypo12, RelO212, VolT12, SedVar12, hypox12, anox12)

#######################
#Thermocline
#calculate thermocline for all lakes in 2007 and 2012
strata07 = home_thermo_fct(deeplat07, 2007)
strata12 = home_thermo_fct(deeplat12, 2012)

#Select those that have a thermocline
thermo07 = strata07[,which(strata07[3,] != -1 & strata07[3,] != strata07[4,])]
thermo12 = strata12[,which(strata12[3,] != -1 & strata12[3,] != strata12[4,])]

##Calculate O2 saturation
O2sat07.th = Eq.Ox.conc(temp.C = Temp_sat[c(1:531), "temp_mean_min_1m"],
                     elevation.m = metadata.more40deep07[,"elevation_m"],
                     out.DO.meas = "mg/L")
names(O2sat07.th) = Temp_sat$station[c(1:531)]
O2sat12.th = Eq.Ox.conc(temp.C = Temp_sat[c(532:1034), "temp_mean_min_1m"],
                     elevation.m = metadata.more40deep12[,"elevation_m"],
                     out.DO.meas = "mg/L")
names(O2sat12.th) = Temp_sat$station[c(532:1034)]


#Remove lakes w/o thermocline
O2sat07.th = O2sat07.th[which(strata07[3,] != -1 & strata07[3,] != strata07[4,])]
O2sat12.th = O2sat12.th[which(strata12[3,] != -1 & strata12[3,] != strata12[4,])]
metadata.thermo07 = metadata.more40deep07[which(strata07[3,] != -1 & strata07[3,] != strata07[4,]),]
metadata.thermo12 = metadata.more40deep12[which(strata12[3,] != -1 & strata12[3,] != strata12[4,]),]


#Remove lakes w/o DO measurements
index07 = list()
for(i in 1:dim(thermo07)[2])
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(thermo07)[i], ".csv"), row.names = 1)
  if(all(is.na(data$DO))) index07[[i]] = i
}

index07 = unlist(index07)

index12 = list()
for(i in 1:dim(thermo12)[2])
{
  data = read.csv(paste0("../data/Preprocessing/2012/",colnames(thermo12)[i], ".csv"), row.names = 1)
  if(all(is.na(data$DO))) index12[[i]] = i
}

index12 = unlist(index12)

O2sat07.th = O2sat07.th[-index07]
thermo07 = thermo07[,-index07]
metadata.thermo07 = metadata.thermo07[-index07,]

O2sat12.th = O2sat12.th[-index12]
thermo12 = thermo12[,-index12]
metadata.thermo12 = metadata.thermo12[-index12,]


#Calculate AOU
AOU07.th = AOU(thermo07, 2007, O2sat07.th)
AOU12.th = AOU(thermo12, 2012, O2sat12.th)

#Calculate volumetric AOU
Area07.th = metadata.thermo07$area_km2*1000*1000
Area12.th = metadata.thermo12$area_km2*1000*1000
VolAOU07.th = VolumetricAOU(AOU07.th, Area07.th)
VolAOU12.th = VolumetricAOU(AOU12.th, Area12.th)


#Calculate volumetric oxygen content
VolO207.th = list()
for(i in 1:length(AOU07.th))
{
  VolO207.th[[i]] = cbind(Depth=AOU07.th[[i]][,1], Sat=O2sat07.th[i])
}
VolO212.th = list()
for(i in 1:length(AOU12.th))
{
  VolO212.th[[i]] = cbind(Depth=AOU12.th[[i]][,1], Sat=O2sat12.th[i])
}

VolSat07.th = VolumetricAOU(VolO207.th, Area07.th)
VolSat12.th = VolumetricAOU(VolO212.th, Area12.th)

#Percentage of O2 consumed
RelO207.th = VolAOU07.th/VolSat07.th*100 #Range from -27% (surtaturated) to 100% (all O2 is consumed)
RelO212.th = VolAOU12.th/VolSat12.th*100 #Range from -9% (sursaturated) to 100% 


#Calculate hypolimnion temperature weighted mean
VolT07.th = VolTemp(thermo07, 2007, Area07.th)
VolT12.th = VolTemp(thermo12, 2012, Area12.th)

#Calculate sediment and volume to sediment ratio
SedVar07.th = SedArea(thermo07, 2007, Area07.th)
SedVar12.th = SedArea(thermo12, 2012, Area12.th)


#Create binary variable for hypoxia and anoxia
hypox07.th = list()
for(i in c(1:dim(thermo07)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(thermo07)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 2) {hypox07.th[[i]] = 1} else {hypox07.th[[i]]=0}
}

anox07.th = list()
for(i in c(1:dim(thermo07)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(thermo07)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 0.5) {anox07.th[[i]] = 1} else {anox07.th[[i]]=0}
}

hypox12.th = list()
for(i in c(1:dim(thermo12)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2012/",colnames(thermo12)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 2) {hypox12.th[[i]] = 1} else {hypox12.th[[i]]=0}
}

anox12.th = list()
for(i in c(1:dim(thermo12)[2]))
{
  data = read.csv(paste0("../data/Preprocessing/2012/",colnames(thermo12)[i], ".csv"), row.names = 1)
  if(min(data$DO, na.rm = T) <= 0.5) {anox12.th[[i]] = 1} else {anox12.th[[i]]=0}
}

hypox07.th = as.factor(unlist(hypox07.th))
anox07.th = as.factor(unlist(anox07.th))
hypox12.th = as.factor(unlist(hypox12.th))
anox12.th = as.factor(unlist(anox12.th))


#Combined dataframes
metadata.thermo07 = cbind(metadata.thermo07, RelO207.th, VolT07.th, SedVar07.th, hypox07.th, anox07.th)
metadata.thermo12 = cbind(metadata.thermo12, RelO212.th, VolT12.th, SedVar12.th, hypox12.th, anox12.th)

#Export all useful dataframes
write.csv(RelO207, "../data/Processed/RelO207.csv", fileEncoding = "UTF-8")
write.csv(hypo07, "../data/Processed/hypo07.csv", fileEncoding = "UTF-8")
write.csv(metadata.hypo07, "../data/Processed/metadata.hypo07.csv", fileEncoding = "UTF-8")

write.csv(RelO212, "../data/Processed/RelO212.csv", fileEncoding = "UTF-8")
write.csv(hypo12, "../data/Processed/hypo12.csv", fileEncoding = "UTF-8")
write.csv(metadata.hypo12, "../data/Processed/metadata.hypo12.csv", fileEncoding = "UTF-8")
```

```{r}
#Cone vs Sed volu
morpho = read.csv("../data/output_morpho.csv", row.names = 1)
#Selectioner lacs avec hypolimnion
morphohypo07.index = morpho$NLA_ID %in% colnames(hypo07)
morphohypo12.index = morpho$NLA_ID %in% colnames(hypo12)
morphohypo07 = morpho[morphohypo07.index,]
morphohypo12 = morpho[morphohypo12.index,]

#Selectionner lac pour hypo oui/non
morpho07.index = morpho$NLA_ID %in% names(Binhypo07)
morpho12.index = morpho$NLA_ID %in% names(Binhypo12)
morpho07 = morpho[morpho07.index,]
morpho12 = morpho[morpho12.index,]
Binhypo12.in = names(Binhypo12) %in% morpho12$NLA_ID 
Binhypo12 = Binhypo12[Binhypo12.in]
  
colnames(morpho07)[1] = "site_id"
colnames(morpho12)[1] = "site_id"
colnames(morphohypo07)[1] = "site_id"
colnames(morphohypo12)[1] = "site_id"

ConeVol07 = vector(length = length(Area07))
for(i in 1:length(Area07))
{
  temp = approx.bathy(Zmax = metadata.hypo07$sampled_depthmax_m[i], lkeArea = Area07[i], zinterval = 0.1)
  output.temp = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		output.temp[j] = pi/3 * h * (r*r + r*R + R*R)
		
  }

  ConeVol07[i] = sum(output.temp)
}

voldev07 = vector(length = length(Area07))
for(i in 1:length(Area07))
{
  temp = approx.bathy(Zmax = metadata.hypo07$sampled_depthmax_m[i], lkeArea = Area07[i], Zmean = morphohypo07$lMeanDepth[i], zinterval = 0.1, method = "voldev")
  output.temp = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		output.temp[j] = pi/3 * h * (r*r + r*R + R*R)
		
  }
  voldev07[i] = sum(output.temp)
}

#Hypolimnion volumes
Conehypo07 = vector(length = length(Area07))
for(i in 1:length(Area07))
{
   temp = approx.bathy(Zmax = metadata.hypo07$sampled_depthmax_m[i], lkeArea = Area07[i], zinterval = 0.1)
   temp = temp[which(temp$depths >= hypo07[3,i]),]
   
    output.temp = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		output.temp[j] = pi/3 * h * (r*r + r*R + R*R)
		
  }

  Conehypo07[i] = sum(output.temp)
}

Voldevhypo07 = vector(length = length(Area07))
for(i in 1:length(Area07))
{
   temp = approx.bathy(Zmax = metadata.hypo07$sampled_depthmax_m[i], lkeArea = Area07[i], Zmean = morphohypo07$lMeanDepth[i], zinterval = 0.1, method = "voldev")
   temp = temp[which(temp$depths >= hypo07[3,i]),]
   
    output.temp = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		output.temp[j] = pi/3 * h * (r*r + r*R + R*R)
		
  }

  Voldevhypo07[i] = sum(output.temp)
}
par(mfrow = c(1,2))
plot(voldev07~ConeVol07,
     xlab = expression(Conical~volume~m^3),
     ylab = expression(Hypsometric~volume~m^3),
     log = "xy",
     las = 1,
     main = "Whole lake volume")
text(x = 1495000, y = 10000000000, labels = expression(Mean~ratio == 1.45))
abline(0,1, lty = 2)
plot(Voldevhypo07~Conehypo07,
     xlab = expression(Conical~volume~m^3),
     ylab = expression(Hypsometric~volume~m^3),
     log = "xy",
     las = 1,
     main = "Hypolimnion volume")
text(x = 5000, y = 5000000000, labels = expression(Mean~ratio == 4.50))
abline(0,1, lty = 2)

#Calculate anoxia/hypoxia relative volume


RAnox07 = vector(length = length(Area07))
for(i in 1:length(Area07))
{
  data = read.csv(paste0("../data/Preprocessing/2007/",colnames(hypo07)[i], ".csv"), row.names = 1)
  anox.temp = (data$DO < 0.5)
  
  if(!any(anox.temp)) { RAnox07[i]=0 } else{
  
    temp = approx.bathy(Zmax = metadata.hypo07$sampled_depthmax_m[i], lkeArea = Area07[i], Zmean = morphohypo07$lMeanDepth[i], zinterval = 0.1, method = "voldev")
    Vol.tot = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		Vol.tot[j] = pi/3 * h * (r*r + r*R + R*R)
  }
  Vol.tot = sum(Vol.tot)
  
  temp = temp[which(temp$depths >= min(data[anox.temp,"depth"], na.rm = T)),]
  
  if(nrow(temp)==1) {
    RAnox07[i]=0
    next}
   
  output.temp = vector(length = length(temp[,2])-1)
  for(j in 1:(length(temp[,2])-1))
  {
    R = sqrt(temp[j,2]/pi)
		r = sqrt(temp[j+1,2]/pi)
		h = temp[j+1,1]-temp[j,1]
		
		output.temp[j] = pi/3 * h * (r*r + r*R + R*R)
		
  }
  RAnox07[i] = sum(output.temp)/Vol.tot*100
  }
}


#Foret aleatoire pour predire p/a hypolimnion
Binforest07 = merge(x = metadata.more40deep07, y = morpho07, by = "site_id")
Binforest07 = missForest(Binforest07[,-c(1,2,3,10,11,12,13,14,36,37)])
Binforest07 = Binforest07$ximp
Binforest07[which(Binforest07$secchi_m > Binforest07$sampled_depthmax_m),"secchi_m"] = Binforest07[which(Binforest07$secchi_m > Binforest07$sampled_depthmax_m),"sampled_depthmax_m"]
Binforest07$Transp.index = Binforest07$secchi_m / Binforest07$sampled_depthmax_m
Binforest07$Binhypo = Binhypo07

Binforest12 = merge(x = metadata.more40deep12, y = morpho12, by = "site_id")
Binforest12 = missForest(Binforest12[,-c(1,2,3,10,11,12,13,14,36,37)])
Binforest12 = Binforest12$ximp
Binforest12[which(Binforest12$secchi_m > Binforest12$sampled_depthmax_m),"secchi_m"] = Binforest12[which(Binforest12$secchi_m > Binforest12$sampled_depthmax_m),"sampled_depthmax_m"]
Binforest12$Transp.index = Binforest12$secchi_m / Binforest12$sampled_depthmax_m
Binforest12$Binhypo = Binhypo12

Bin0712 = rbind(Binforest07[,-11], Binforest12)

Binhypopred = c("lat", "lon","area_km2", "elevation_m", "basinarea_km2", "chla_ugL", "NTL_ugL", "PTL_ugL", "DOC_mgL", "secchi_m", "color_PCU","WALA_ratio", "pct_forest", "pct_agric",  "nutrient_color", "Transp.index", "lMeanDepth","lMinorAxisLength", "lFetch", "MaxDepth", "Binhypo")

BF0712 = Bin0712[,Binhypopred]
BF0712$Binhypo = as.factor(BF0712$Binhypo)

set.seed(101)
#Train and test datasets
train0712 = sample(1:nrow(BF0712), 0.6*nrow(BF0712))
test0712 = which(!1:nrow(BF0712) %in% train0712)

#Create output matrix and name columns
out.mat = matrix(nrow = ncol(BF0712))
rownames(out.mat) = c("All", colnames(BF0712)[-length(colnames(BF0712))])

#Random Forest on all variables
rf.bh0712 = randomForest(Binhypo~MaxDepth+lMeanDepth+lFetch, data=BF0712, subset = train0712)
rf.bt0712 = predict(rf.bh0712, newdata = BF0712[test0712,])
out.mat[1,1] = mean(abs(as.numeric(BF0712[test0712,"Binhypo"]) - as.numeric(rf.bt0712)))
for(i in 1:(dim(BF0712)[2]-1))
{
  BF0712.temp = BF0712[,-i]
  rf.bh0712 = randomForest(Binhypo~., data=BF0712.temp, subset = train0712)
  rf.bt0712 = predict(rf.bh0712, newdata = BF0712.temp[test0712,])
  out.mat[i+1,1] = mean(abs(as.numeric(BF0712.temp[test0712,"Binhypo"]) - as.numeric(rf.bt0712)))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

plot(rf.bt0712 ~ BF0712[test0712,"Binhypo"],
     xlab = expression(Presence/absence~hypolimnion),
     # xlim = c(-4,4),
     # ylim = c(-2,3),
     ylab = expression(Predicted~presence/absence~hypolimnion),
     las = 1)


rtparty0712 = ctree(Binhypo ~ ., data=BF0712[test0712,], controls=cforest_control(mtry=NULL, mincriterion=3))
#pdf("../output/tree0712.pdf", width = 30, height = 15)
plot(rtparty0712)



ilpd_ctree_1 <- ctree(Binhypo ~ .  ,data=BF0712[test0712,], controls=ctree_control(maxdepth=1))
ilpd_ctree_1
plot(ilpd_ctree_1)
treepre_1 <- predict(ilpd_ctree_1,BF0712[test0712,])
confusionMatrix(BF0712[test0712,"Binhypo"],treepre_1)
table(treepre_1,BF0712[test0712,"Binhypo"])

ilpd_ctree_2 <- ctree(Binhypo ~ .  ,data=BF0712[test0712,], controls=ctree_control(maxdepth=2))
ilpd_ctree_2
plot(ilpd_ctree_2)
treepre_2 <- predict(ilpd_ctree_2,BF0712[test0712,])
confusionMatrix(BF0712[test0712,"Binhypo"],treepre_2)
table(treepre_2,BF0712[test0712,"Binhypo"])


####Foret aleatoire pour predire l'epaisseur de l'hypolimnion
HT07 = merge(x = metadata.hypo07, y = morphohypo07, by = "site_id")
HT07 = missForest(HT07[,-c(1,2,3,10,11,12,13,14,36,37)])
HT07 = HT07$ximp
HT07[which(HT07$secchi_m > HT07$sampled_depthmax_m),"secchi_m"] = HT07[which(HT07$secchi_m > HT07$sampled_depthmax_m),"sampled_depthmax_m"]
HT07$Transp.index = HT07$secchi_m / HT07$sampled_depthmax_m


HT12 = merge(x = metadata.hypo12, y = morphohypo12, by = "site_id")
HT12 = missForest(HT12[,-c(1,2,3,10,11,12,13,14,36,37)])
HT12 = HT12$ximp
HT12[which(HT12$secchi_m > HT12$sampled_depthmax_m),"secchi_m"] = HT12[which(HT12$secchi_m > HT12$sampled_depthmax_m),"sampled_depthmax_m"]
HT12$Transp.index = HT12$secchi_m / HT12$sampled_depthmax_m


HT0712 = rbind(HT07[,-c(11,52,53,57,58)], HT12[,-c(51,52,56,57)]) #"RelO212" "VolT12"  "hypox12" "anox12" 

HTpred = c("lat", "lon","area_km2", "elevation_m", "basinarea_km2", "chla_ugL", "NTL_ugL", "PTL_ugL", "DOC_mgL", "secchi_m", "color_PCU","WALA_ratio", "pct_forest", "pct_agric",  "nutrient_color", "Transp.index", "lMeanDepth","lMinorAxisLength", "lFetch", "sampled_depthmax_m", "HypoThick")

HTF0712 = HT0712[,HTpred]


set.seed(101)
#Train and test datasets
train0712 = sample(1:nrow(HTF0712), 0.6*nrow(HTF0712))
test0712 = which(!1:nrow(HTF0712) %in% train0712)

#Create output matrix and name columns
out.mat = matrix(nrow = ncol(HTF0712))
rownames(out.mat) = c("All", colnames(HTF0712)[-length(colnames(HTF0712))])

#Random Forest on all variables
rf.HTF0712 = randomForest(HypoThick~., data=HTF0712, subset = train0712)
rf.HTFt0712 = predict(rf.HTF0712, newdata = HTF0712[test0712,])
out.mat[1,1] = mean(abs(HTF0712[test0712,"HypoThick"] - rf.HTFt0712))
for(i in 1:(dim(HTF0712)[2]-1))
{
  HTF0712.temp = HTF0712[,-i]
  rf.HTF0712 = randomForest(HypoThick~., data=HTF0712.temp, subset = train0712)
  rf.HTFt0712 = predict(rf.HTF0712, newdata = HTF0712.temp[test0712,])
  out.mat[i+1,1] = mean(abs(HTF0712.temp[test0712,"HypoThick"] - rf.HTFt0712))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

summary(lm(rf.HTFt0712 ~ HTF0712[test0712,"HypoThick"]))
plot(rf.HTFt0712 ~ HTF0712[test0712,"HypoThick"],
     xlab = expression(Hypolimnion~thickness),
     # xlim = c(-4,4),
     # ylim = c(-2,3),
     ylab = expression(Predicted~hypolimnion~thickness),
     las = 1)
rtparty.HT0712 = ctree(HypoThick ~ ., data=HTF0712[test0712,], controls=cforest_control(mtry=NULL, mincriterion=3))
#pdf("../output/tree0712.pdf", width = 30, height = 15)
plot(rtparty.HT0712)


ilpd_ctree_1 <- ctree(HypoThick ~ ., data=HTF0712[test0712,], controls = ctree_control(maxdepth = 1))
ilpd_ctree_1
plot(ilpd_ctree_1)
treepre_1 <- predict(ilpd_ctree_1, HTF0712[test0712,])
#confusionMatrix(HTF0712[test0712, "HypoThick"], treepre_1)
#table(treepre_1, HTF0712[test0712, "HypoThick"])
mean(abs(HTF0712.temp[test0712,"HypoThick"] - treepre_1))

#Transformer l'epaisseur de l'hypo en proportion du lac
RHTF0712 = HTF0712
RHTF0712$HypoProp = HTF0712$HypoThick/HTF0712$sampled_depthmax_m
RHTF0712 = RHTF0712[,-c(21)]

#51-73

set.seed(101)
#Train and test datasets
train0712 = sample(1:nrow(RHTF0712), 0.6*nrow(RHTF0712))
test0712 = which(!1:nrow(RHTF0712) %in% train0712)

#Create output matrix and name columns
out.mat = matrix(nrow = ncol(RHTF0712))
rownames(out.mat) = c("All", colnames(RHTF0712)[-length(colnames(RHTF0712))])

#Random Forest on all variables
rf.RHTF0712 = randomForest(HypoProp~., data=RHTF0712, subset = train0712)
rf.RHTFt0712 = predict(rf.RHTF0712, newdata = RHTF0712[test0712,])
out.mat[1,1] = mean(abs(RHTF0712[test0712,"HypoProp"] - rf.RHTFt0712))
for(i in 1:(dim(RHTF0712)[2]-1))
{
  RHTF0712.temp = RHTF0712[,-i]
  rf.RHTF0712 = randomForest(HypoProp~., data=RHTF0712.temp, subset = train0712)
  rf.RHTFt0712 = predict(rf.RHTF0712, newdata = RHTF0712.temp[test0712,])
  out.mat[i+1,1] = mean(abs(RHTF0712.temp[test0712,"HypoProp"] - rf.RHTFt0712))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

summary(lm(rf.RHTFt0712 ~ RHTF0712[test0712,"HypoProp"]))
plot(rf.RHTFt0712 ~ RHTF0712[test0712,"HypoProp"],
     xlab = expression(Relative~hypolimnion~thickness),
     # xlim = c(-4,4),
     # ylim = c(-2,3),
     ylab = expression(Predicted~relative~hypolimnion~thickness),
     las = 1)
rtparty.RHT0712 = ctree(HypoProp ~ ., data=RHTF0712[test0712,], controls=cforest_control(mtry=NULL, mincriterion=2))
#pdf("../output/tree0712.pdf", width = 30, height = 15)
plot(rtparty.RHT0712)


ilpd_ctree_1 <- ctree(HypoProp ~ ., data=RHTF0712[test0712,], controls = ctree_control(maxdepth = 1))
ilpd_ctree_1
plot(ilpd_ctree_1)
treepre_1 <- predict(ilpd_ctree_1, RHTF0712[test0712,])
#confusionMatrix(HTF0712[test0712, "HypoThick"], treepre_1)
#table(treepre_1, HTF0712[test0712, "HypoThick"])
mean(abs(RHTF0712.temp[test0712,"HypoProp"] - treepre_1))

#With data transformation
#Transformer l'epaisseur de l'hypo en proportion du lac
RHTF0712.t = cbind(RHTF0712[,c(1,2,13:15)],log(RHTF0712[,c(3:12,16:19)]), HypoProp=RHTF0712[,21])
RHTF0712.t[RHTF0712.t==-Inf] = 0
#20 is sampled_maxdepth
                                        
#51-73

set.seed(101)
#Train and test datasets
train0712 = sample(1:nrow(RHTF0712.t), 0.6*nrow(RHTF0712.t))
test0712 = which(!1:nrow(RHTF0712.t) %in% train0712)

#Create output matrix and name columns
out.mat = matrix(nrow = ncol(RHTF0712.t))
rownames(out.mat) = c("All", colnames(RHTF0712.t)[-length(colnames(RHTF0712.t))])

#Random Forest on all variables
rf.RHTF0712.t = randomForest(HypoProp~., data=RHTF0712.t, subset = train0712)
rf.RHTFt0712 = predict(rf.RHTF0712.t, newdata = RHTF0712.t[test0712,])
out.mat[1,1] = mean(abs(RHTF0712.t[test0712,"HypoProp"] - rf.RHTFt0712))
for(i in 1:(dim(RHTF0712.t)[2]-1))
{
  RHTF0712.t.temp = RHTF0712.t[,-i]
  rf.RHTF0712.t = randomForest(HypoProp~., data=RHTF0712.t.temp, subset = train0712)
  rf.RHTFt0712 = predict(rf.RHTF0712.t, newdata = RHTF0712.t.temp[test0712,])
  out.mat[i+1,1] = mean(abs(RHTF0712.t.temp[test0712,"HypoProp"] - rf.RHTFt0712))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

summary(lm(rf.RHTFt0712 ~ RHTF0712.t[test0712,"HypoProp"]))
plot(rf.RHTFt0712 ~ RHTF0712.t[test0712,"HypoProp"],
     xlab = expression(Relative~hypolimnion~thickness),
     # xlim = c(-4,4),
     # ylim = c(-2,3),
     ylab = expression(Predicted~relative~hypolimnion~thickness),
     las = 1)
rtparty.RHT0712 = ctree(HypoProp ~ ., data=RHTF0712.t[test0712,], controls=cforest_control(mtry=NULL, mincriterion=2))
#pdf("../output/tree0712.pdf", width = 30, height = 15)
plot(rtparty.RHT0712)


ilpd_ctree_1 <- ctree(HypoProp ~ ., data=RHTF0712.t[test0712,], controls = ctree_control(maxdepth = 1))
ilpd_ctree_1
plot(ilpd_ctree_1)
treepre_1 <- predict(ilpd_ctree_1, RHTF0712.t[test0712,])
#confusionMatrix(HTF0712[test0712, "HypoThick"], treepre_1)
#table(treepre_1, HTF0712[test0712, "HypoThick"])
mean(abs(RHTF0712.t.temp[test0712,"HypoProp"] - treepre_1))





RelO207 = read.csv("../data/Processed/RelO207.csv", row.names = 1)
hypo07 = read.csv("../data/Processed/hypo07.csv", row.names = 1)
metadata.hypo07 = read.csv("../data/Processed/metadata.hypo07.csv", row.names = 1)
colnames(metadata.hypo07)[62] = "RelO2"
colnames(metadata.hypo07)[63] = "VolT"
colnames(metadata.hypo07)[67] = "Hypox"
colnames(metadata.hypo07)[68] = "Anox"

MF.hypo07 = missForest(metadata.hypo07[,-c(1,2,9,10,11,14,35,36,38)])
MF.hypo07 = MF.hypo07$ximp
MF.hypo07[212,"secchi_m"] = MF.hypo07[212,"depthmax_m"]
MF.hypo07$Transp.index = MF.hypo07$secchi_m / MF.hypo07$sampled_depthmax_m

RelO212 = read.csv("../data/Processed/RelO212.csv", row.names = 1)
hypo12 = read.csv("../data/Processed/hypo12.csv", row.names = 1)
metadata.hypo12 = read.csv("../data/Processed/metadata.hypo12.csv", row.names = 1)
colnames(metadata.hypo12)[62] = "RelO2"
colnames(metadata.hypo12)[63] = "VolT"
colnames(metadata.hypo12)[67] = "Hypox"
colnames(metadata.hypo12)[68] = "Anox"
MF.hypo12 = missForest(metadata.hypo12[,-c(1,2,9,10,11,14,35,36,38)])
MF.hypo12 = MF.hypo12$ximp
MF.hypo12$Transp.index = MF.hypo12$secchi_m / MF.hypo12$sampled_depthmax_m




#Select useful column
Selection = c("lat", "lon","area_km2", "elevation_m", "sampled_depthmax_m", "basinarea_km2", "chla_ugL", "NTL_ugL", "PTL_ugL", "DOC_mgL", "secchi_m", "color_PCU", "VolT", "SedArea", "VoltoSedArea", "HypoThick", "WALA_ratio", "pct_forest", "pct_agric", "Julian.day", "nutrient_color", "Hypox", "Anox","Transp.index", "RelO2")
#ratio dynamique: profondeur moyenne/racine3 de l'aire
data07 = MF.hypo07[,Selection]
# data07[,c(3:17)] = log(data07[,c(3:17)]+1)
# data07[,c(3:17)] = scale(data07[,c(3:17)])
# data07[,c(18,19)] = logit(data07[,c(18,19)])

#TEST
# data07[which(data07$RelO2 == min(data07$RelO2)),"RelO2"] = 0 #Run 3 times
# data07$RelO2 = logit(data07$RelO2)

pdf("../output/Distributions07.pdf")
for(i in 1:20)
{
    hist(data07[,i], main = colnames(data07[i]))
}
dev.off()

set.seed(110)
train07 = sample(1:nrow(metadata.hypo07), 130)
test07 = which(!1:nrow(metadata.hypo07) %in% train07)
out.mat = matrix(nrow = length(Selection)-1)
rownames(out.mat) = Selection[-22]
for(i in 1:(length(Selection)-1))
{
  data07.temp = data07[,-i]
  rf.hypo07 = randomForest(RelO2~., data=data07.temp, subset = train07)
  rf.test07 = predict(rf.hypo07, newdata = data07.temp[test07,])
  out.mat[i,1] = mean(abs(data07.temp[test07,"RelO2"] - rf.test07))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

rf.hypo07
rf.test07 = predict(rf.hypo07, newdata = data07[test07,])

#Combined data sets
Selection = c("lat", "lon","area_km2", "elevation_m", "sampled_depthmax_m", "basinarea_km2", "chla_ugL", "NTL_ugL", "PTL_ugL", "DOC_mgL", "secchi_m", "color_PCU", "VolT", "SedArea", "VoltoSedArea", "HypoThick", "WALA_ratio", "pct_forest", "pct_agric", "Julian.day", "nutrient_color", "Hypox", "Anox", "Transp.index", "RelO2")
#ratio dynamique: profondeur moyenne/racine3 de l'aire
data0712 = rbind(MF.hypo07[,Selection], MF.hypo12[,Selection])
data0712$DOC_umol = data0712$DOC_mgL/12.0107*1000
data0712$NTL_umol = data0712$NTL_ugL/14.0067
data0712$PTL_umol = data0712$PTL_ugL/30.973762
data0712$RatioNP = log(data0712$NTL_umol) / log(data0712$PTL_umol)

data0712 = cbind(data0712[,-c(8,9,10,25)], RelO2=data0712[,"RelO2"])

# data0712[,c(3:17)] = log(data0712[,c(3:17)]+1)
# data0712[,c(3:17,21,22,23)] = scale(data0712[,c(3:17,21,22,23)])
# data0712[,c(18,19)] = logit(data0712[,c(18,19)])

set.seed(101)
train0712 = sample(1:nrow(data0712), 0.6*nrow(data0712))
test0712 = which(!1:nrow(data0712) %in% train0712)
out.mat = matrix(nrow = dim(data0712)[2])
rownames(out.mat) = c("All", colnames(data0712)[-length(colnames(data0712))])
rf.hypo0712 = randomForest(RelO2~., data=data0712, subset = train0712)
rf.test0712 = predict(rf.hypo0712, newdata = data0712[test0712,])
out.mat[1,1] = mean(abs(data0712[test0712,"RelO2"] - rf.test0712))
for(i in 1:(dim(data0712)[2]-1))
{
  data0712.temp = data0712[,-i]
  rf.hypo0712 = randomForest(RelO2~., data=data0712.temp, subset = train0712)
  rf.test0712 = predict(rf.hypo0712, newdata = data0712.temp[test0712,])
  out.mat[i+1,1] = mean(abs(data0712.temp[test0712,"RelO2"] - rf.test0712))
}
as.matrix(out.mat[order(out.mat, decreasing = T),])

summary(lm(rf.test0712 ~ data0712[test0712,"RelO2"]))
plot(rf.test0712 ~ data0712[test0712,"RelO2"],
     xlab = expression(Calculted~O[2]~deficit),
     # xlim = c(-4,4),
     # ylim = c(-2,3),
     ylab = expression(Predicted~O[2]~deficit),
     las = 1)
abline(lm(rf.test0712 ~ data0712[test0712,"RelO2"]))


rtparty0712 = ctree(RelO2 ~ ., data=data0712, controls=cforest_control(mtry=2, mincriterion=0))
pdf("../output/tree0712.pdf", width = 30, height = 15)
plot(rtparty0712)
dev.off()

#Test with very few variables
Sub.select = c("NTL_umol", "sampled_depthmax_m", "secchi_m", "WALA_ratio", "DOC_umol", "PTL_umol", "chla_ugL", "Julian.day", "VolT","pct_forest", "Transp.index", "RelO2")#"Hypox"

all.pairs = list()
counter = 1
for(i in 1:(length(Sub.select)-2))
{
  for(j in (i+1):(length(Sub.select)-1))
  {
    #if(j==length(Sub.select)-1) break
    pair = c(i,j)
    all.pairs[[counter]] = pair
    counter = counter+1
  }
}

sub.data0712 = data0712[,Sub.select]
set.seed(101)
train0712 = sample(1:nrow(sub.data0712), 0.6*nrow(sub.data0712))
test0712 = which(!1:nrow(sub.data0712) %in% train0712)
out.mat = matrix(nrow = length(all.pairs)+1)
rownames(out.mat) = rep("All",length(all.pairs)+1)

rf.hypo0712.main = randomForest(RelO2~., data=sub.data0712, subset = train0712)
rf.test0712.main = predict(rf.hypo0712.main, newdata = sub.data0712[test0712,])
out.mat[1,1] = mean(abs(sub.data0712[test0712,"RelO2"] - rf.test0712.main))

for(i in 1:length(all.pairs))
{
  sub.data0712.temp = sub.data0712[,-all.pairs[[i]]]
  rf.hypo0712 = randomForest(RelO2~., data=sub.data0712.temp, subset = train0712)
  rf.test0712 = predict(rf.hypo0712, newdata = sub.data0712.temp[test0712,])
  out.mat[i+1,1] = mean(abs(sub.data0712.temp[test0712,"RelO2"] - rf.test0712))
  rownames(out.mat)[i+1] = paste(colnames(sub.data0712)[all.pairs[[i]]][1],colnames(sub.data0712)[all.pairs[[i]]][2],sep="-")
}
as.matrix(out.mat[order(out.mat, decreasing = T),])
plot(rf.test0712.main ~ sub.data0712[test0712,"RelO2"])
summary(lm(rf.test0712.main ~ sub.data0712[test0712,"RelO2"]))

rtparty0712 = ctree(RelO2 ~ ., data=sub.data0712, controls=cforest_control(mtry=2, mincriterion=2))
plot(rtparty0712)

rfparty0712 = cforest(RelO2 ~ ., data=sub.data0712, controls=cforest_control(mtry=2, mincriterion=0))
varimp(rfparty0712)[order(varimp(rfparty0712),decreasing = T)]


rfparty07 = cforest(RelO2 ~ ., data=data07, controls=cforest_control(mtry=2, mincriterion=0))
rtparty07 = ctree(RelO2 ~ ., data=data07, controls=cforest_control(mtry=2, mincriterion=0), )
getwd()
pdf("../output/tree.pdf", width = 30, height = 15)
plot(rtparty07)
dev.off()

varimp(rfparty07, )[order(varimp(rfparty07),decreasing = T)]


summary(lm(predict(rfparty07)~data07$RelO2))
plot(predict(rfparty07) ~ data07$RelO2,
     xlab = "Calculted O2 deficit (logit transformed)",
     xlim = c(-4,4),
     ylim = c(-2,3),
     ylab = "Predicted O2 deficit (logit transformed)",
     las = 1)
abline(lm(predict(rfparty07)~data07$RelO2))



data12 = metadata.hypo12[,Selection]


rfparty12 = cforest(RelO2 ~ ., data=data12, controls=cforest_control(mtry=2, mincriterion=0))
summary(lm(predict(rfparty12)~RelO212[,1]))
plot(predict(rfparty12) ~ RelO212[,1],
     xlab = "Calculted O2 deficit (%)",
     ylab = "Predicted O2 deficit (%)",
     las = 1)

rfparty0712 = cforest(RelO2 ~ ., data=rbind(data07,data12), controls = cforest_control(mtry=2, mincriterion=0))
summary(lm(predict(rfparty0712)~c(RelO207[,1],RelO212[,1])))
plot(predict(rfparty0712) ~ c(RelO207[,1],RelO212[,1]),
     xlab = "Calculted O2 deficit (%)",
     ylab = "Predicted O2 deficit (%)",
     las = 1)

oob.err = double(13)
test.err = double(13)

for(mtry in 1:19){
  fit = randomForest(RelO2~., data = data07, subset=train07, mtry=mtry, ntree = 130)
  oob.err[mtry] = fit$mse[130]
  pred = predict(fit, data07[-train07,])
  test.err[mtry] = with(data07[-train07,], mean( (data07[-train07,"RelO2"]-pred)^2))
}

matplot(1:mtry, cbind(test.err, oob.err), pch = 23, col = c("red", "blue"), type = "b", ylab="Mean Squared Error")
legend("topright", legend = c("Test", "OOB"), pch = 23, col = c("red", "blue"))
```

#Preliminary graph: profiles
```{r}
pdf(file = paste0("../output/2007/AllProfiles.pdf"), width = 14, height = 4)
for(i in 1:length(allfiles07)){
  data = read.csv(paste0("../data/2007/", allfiles07[i]))
  
   if(length(unique(data$temp) == "NA") == 1) data$temp = 1

  filename = unlist(strsplit(allfiles07[i],split = "[.]"))[1]
  
  density = rLakeAnalyzer::water.density(data$temp, sal = data$temp * 0)
  

  par(mfrow=c(1,3))
  par(mar=c(5,5,4,1)+0.1)
  plot(data$depth~data$temp,
     ylim = rev(range(data$depth)),
     las = 1,
     xlab = "Temperature (°C)",
     ylab = "Depth (m)",
     pch = 16,
     col = "red",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  mtext(paste(filename), side = 3, at = max(data$temp[!is.nan(data$temp)]), cex = 1.8)
  if(strata07[2,i] != -1) abline(h = strata07[2,i], lty=2, lwd=2, col = "blue")
  if(strata07[3,i] != -1) abline(h = strata07[3,i], lty=2, lwd=2, col = "blue")
  
  plot(data$depth~density,
     ylim = rev(range(data$depth)),
     las = 1,
     xlab = "Density",
     ylab = "Depth (m)",
     pch = 16,
     col = "green",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  if(strata07[2,i] != -1) abline(h = strata07[2,i], lty=2, lwd=2, col = "blue")
  if(strata07[3,i] != -1) abline(h = strata07[3,i], lty=2, lwd=2, col = "blue")
  
  plot(data$depth~data$DO,
     ylim = rev(range(data$depth)),
     las = 1,
     xlim = c(0,12),
     xlab = "Oxygen (mg/L)",
     ylab = "Depth (m)",
     pch = 16,
     col = "gold",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  if(strata07[2,i] != -1) abline(h = strata07[2,i], lty=2, lwd=2, col = "blue")
  if(strata07[3,i] != -1) abline(h = strata07[3,i], lty=2, lwd=2, col = "blue")
}
dev.off()

pdf(file = paste0("../output/2012/AllProfiles.pdf"), width = 14, height = 4)
for(i in 1:length(allfiles12)){
  data = read.csv(paste0("../data/2012/", allfiles12[i]))
  if(length(unique(data$temp) == "NA") == 1) data$temp = 1
  filename = unlist(strsplit(allfiles12[i],split = "[.]"))[1]
  
  density = rLakeAnalyzer::water.density(data$temp, sal = data$temp * 0)
  

  par(mfrow=c(1,3))
  par(mar=c(5,5,4,1)+0.1)
  plot(data$depth~data$temp,
     ylim = rev(range(data$depth)),
     las = 1,
     xlab = "Temperature (°C)",
     ylab = "Depth (m)",
     pch = 16,
     col = "red",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  mtext(paste(filename), side = 3, at = max(data$temp[!is.nan(data$temp)]), cex = 1.8)
  if(strata12[2,i] != -1) abline(h = strata12[2,i], lty=2, lwd=2, col = "blue")
  if(strata12[3,i] != -1) abline(h = strata12[3,i], lty=2, lwd=2, col = "blue")
  
  plot(data$depth~density,
     ylim = rev(range(data$depth)),
     las = 1,
     xlab = "Density",
     ylab = "Depth (m)",
     pch = 16,
     col = "green",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  if(strata12[2,i] != -1) abline(h = strata12[2,i], lty=2, lwd=2, col = "blue")
  if(strata12[3,i] != -1) abline(h = strata12[3,i], lty=2, lwd=2, col = "blue")
  
  plot(data$depth~data$DO,
     ylim = rev(range(data$depth)),
     las = 1,
     xlim = c(0,12),
     xlab = "Oxygen (mg/L)",
     ylab = "Depth (m)",
     pch = 16,
     col = "gold",
     cex = 1.8,
     cex.axis = 1.8,
     cex.lab = 1.8)
  if(strata12[2,i] != -1) abline(h = strata12[2,i], lty=2, lwd=2, col = "blue")
  if(strata12[3,i] != -1) abline(h = strata12[3,i], lty=2, lwd=2, col = "blue")
}
dev.off()



```